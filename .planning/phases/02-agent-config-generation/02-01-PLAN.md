---
phase: 02-agent-config-generation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/claude_teams/config_gen.py
  - tests/test_config_gen.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "generate_agent_config() returns a string starting with YAML frontmatter delimiters (---)"
    - "Parsed YAML frontmatter contains mode='primary', permission='allow' (string), model field, and tools dict with claude-teams_* enabled"
    - "System prompt body contains agent identity (name, team_name, agent_id, color)"
    - "System prompt contains inbox polling instructions with fully-qualified tool name claude-teams_read_inbox and polling frequency"
    - "System prompt contains task management instructions with claude-teams_task_list and claude-teams_task_update tool names"
    - "write_agent_config() creates .opencode/agents/<name>.md at correct path with correct content"
    - "ensure_opencode_json() creates or merges opencode.json with claude-teams MCP server entry without losing existing config"
  artifacts:
    - path: "src/claude_teams/config_gen.py"
      provides: "Agent config generation, file writing, opencode.json management"
      exports: ["generate_agent_config", "write_agent_config", "ensure_opencode_json"]
    - path: "tests/test_config_gen.py"
      provides: "Comprehensive tests for all three functions"
      min_lines: 100
  key_links:
    - from: "src/claude_teams/config_gen.py"
      to: "yaml.dump"
      via: "PyYAML for YAML frontmatter generation"
      pattern: "yaml\\.dump"
    - from: "src/claude_teams/config_gen.py"
      to: "opencode.json"
      via: "json read-modify-write for MCP server registration"
      pattern: "json\\.loads.*json\\.dumps"
---

<objective>
Create the `config_gen.py` module with three core functions for OpenCode agent configuration: `generate_agent_config()` (builds the complete markdown string), `write_agent_config()` (writes it to `.opencode/agents/<name>.md`), and `ensure_opencode_json()` (registers the claude-teams MCP server in `opencode.json`). Use TDD: write failing tests first, then implement to pass.

Purpose: This module is the foundation of Phase 2 -- every requirement (SPAWN-02 through MCP-01, RELY-02) is satisfied by these three functions. The generated config gives spawned OpenCode agents their identity, communication protocol, task management instructions, and MCP tool access with correct permissions.

Output: Working `config_gen.py` module with full test coverage via TDD.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-agent-config-generation/02-RESEARCH.md
@src/claude_teams/spawner.py
@src/claude_teams/models.py
</context>

<feature>
  <name>Agent Config Generation Module</name>
  <files>src/claude_teams/config_gen.py, tests/test_config_gen.py, pyproject.toml</files>
  <behavior>
    Three functions with defined input/output contracts:

    1. `generate_agent_config(agent_id, name, team_name, color, model) -> str`
       - Returns a complete markdown string with YAML frontmatter and system prompt body
       - Frontmatter contains: description, model, mode="primary", tools dict (all builtins + claude-teams_*=True), permission="allow"
       - System prompt body contains:
         - Identity section: agent name (bold), team name (bold), agent_id (code), color
         - Inbox polling: instructions to call `claude-teams_read_inbox` every 3-5 tool calls, check before new work
         - Sending messages: instructions to use `claude-teams_send_message` with recipient parameter
         - Task claiming: instructions with `claude-teams_task_list` and `claude-teams_task_update` tool names, status values "in_progress" and "completed"
         - Shutdown protocol: instructions to handle shutdown_request messages

    2. `write_agent_config(project_dir, name, config_content) -> Path`
       - Creates `.opencode/agents/` directory if needed (mkdir parents=True, exist_ok=True)
       - Writes config_content to `.opencode/agents/<name>.md` with UTF-8 encoding
       - Overwrites existing file (re-spawn scenario)
       - Returns path to the created file

    3. `ensure_opencode_json(project_dir, mcp_server_command, mcp_server_env=None) -> Path`
       - If opencode.json does not exist: creates with $schema key and mcp section
       - If opencode.json exists: reads, merges claude-teams into mcp section, preserves all other keys
       - MCP entry: {"type": "local", "command": mcp_server_command, "enabled": true}
       - If mcp_server_env provided, adds "environment" key
       - Returns path to opencode.json

    Test cases (RED phase):
    - generate_agent_config: frontmatter delimiters, required fields (mode, model, permission, tools), identity in body, inbox polling instructions, task management instructions, permission is string "allow" not boolean, all builtin tools enabled, claude-teams_* enabled
    - write_agent_config: creates directory structure, file content matches, overwrites existing
    - ensure_opencode_json: creates new file, preserves existing config, updates existing MCP entry, adds environment when provided
  </behavior>
  <implementation>
    RED phase: Create tests/test_config_gen.py with all test cases. Tests import from config_gen and call the three functions. Run pytest -- all tests must FAIL (ImportError or assertion errors).

    GREEN phase: Create src/claude_teams/config_gen.py implementing all three functions. Add `pyyaml>=6.0` to pyproject.toml dependencies. Use yaml.dump(frontmatter, default_flow_style=False, sort_keys=False) for YAML generation. Use textwrap.dedent for system prompt. Run pytest -- all tests must PASS.

    REFACTOR phase (if needed): Clean up any code duplication, ensure consistent style with codebase conventions (from __future__ import annotations, type hints, docstrings).

    Key implementation details:
    - YAML frontmatter: Use `yaml.dump()` for the dict, wrap with `---\n` prefix and `---\n\n` suffix
    - Tools dict must include: read, write, edit, bash, glob, grep, list, webfetch, websearch, todoread, todowrite (all True), plus "claude-teams_*": True
    - Permission field: `"permission": "allow"` -- this is the shorthand that applies to ALL tools. Must be string "allow", not boolean True
    - Mode: "primary" -- required for `opencode run --agent` CLI usage
    - System prompt tool references must use fully-qualified names with `claude-teams_` prefix (e.g., `claude-teams_read_inbox`, NOT just `read_inbox`)
    - Agent name is used in tool call parameter examples: `read_inbox(team_name="{team_name}", agent_name="{name}")`
    - ensure_opencode_json uses read-modify-write pattern with dict.setdefault("mcp", {}) to avoid losing existing config
    - File writes use encoding="utf-8" consistently
  </implementation>
</feature>

<verification>
```bash
# All tests pass
python -m pytest tests/test_config_gen.py -v

# Module is importable
python -c "from claude_teams.config_gen import generate_agent_config, write_agent_config, ensure_opencode_json; print('OK')"

# Syntax validation
python -m py_compile src/claude_teams/config_gen.py
python -m py_compile tests/test_config_gen.py

# PyYAML is declared in pyproject.toml
grep "pyyaml" pyproject.toml
```
</verification>

<success_criteria>
- generate_agent_config() produces valid YAML frontmatter with mode="primary", permission="allow" (string), all tools enabled, and claude-teams_* enabled
- System prompt contains identity, inbox polling (with claude-teams_read_inbox), task management (with claude-teams_task_list and claude-teams_task_update), and shutdown protocol
- write_agent_config() creates files at .opencode/agents/<name>.md with correct content
- ensure_opencode_json() creates/merges opencode.json preserving existing keys
- All tests pass (RED->GREEN->REFACTOR cycle completed)
- PyYAML added to pyproject.toml dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/02-agent-config-generation/02-01-SUMMARY.md`
</output>
