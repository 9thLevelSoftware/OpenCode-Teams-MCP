---
phase: 02-agent-config-generation
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/claude_teams/spawner.py
  - src/claude_teams/server.py
  - tests/test_spawner.py
  - tests/test_server.py
autonomous: true

must_haves:
  truths:
    - "spawn_teammate() generates an agent config file at .opencode/agents/<name>.md before executing the spawn command"
    - "spawn_teammate() ensures opencode.json has the claude-teams MCP server registered before spawning"
    - "force_kill_teammate cleans up .opencode/agents/<name>.md when killing an agent"
    - "process_shutdown_approved cleans up .opencode/agents/<name>.md when processing shutdown"
    - "spawn_teammate accepts a project_dir parameter for config file generation"
  artifacts:
    - path: "src/claude_teams/spawner.py"
      provides: "Config generation integrated into spawn flow, cleanup on kill/shutdown"
      contains: "generate_agent_config"
    - path: "src/claude_teams/server.py"
      provides: "project_dir passed through to spawner, cleanup calls in force_kill and shutdown"
      contains: "config_gen"
    - path: "tests/test_spawner.py"
      provides: "Tests for spawn_teammate config generation integration"
      contains: "test_spawn_generates_agent_config"
    - path: "tests/test_server.py"
      provides: "Tests for server-level config gen wiring"
      contains: "config_gen"
  key_links:
    - from: "src/claude_teams/spawner.py"
      to: "src/claude_teams/config_gen.py"
      via: "import and call generate_agent_config, write_agent_config, ensure_opencode_json"
      pattern: "from claude_teams\\.config_gen import"
    - from: "src/claude_teams/server.py"
      to: "src/claude_teams/config_gen.py"
      via: "import for cleanup function (delete agent config file)"
      pattern: "config_gen"
    - from: "src/claude_teams/spawner.py"
      to: ".opencode/agents/<name>.md"
      via: "write_agent_config call in spawn_teammate"
      pattern: "write_agent_config"
---

<objective>
Wire the config_gen module into the spawn and cleanup flows. spawn_teammate() must generate the agent config and register the MCP server before executing the spawn command. force_kill_teammate and process_shutdown_approved must clean up the agent config file when removing an agent.

Purpose: Without this wiring, the config_gen module exists but is never called. This plan connects it to the actual spawn lifecycle so that spawning a teammate produces the correct `.opencode/agents/<name>.md` file and `opencode.json` MCP registration, and killing/removing an agent cleans up the config file.

Output: Integrated spawn flow with config generation and cleanup.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-agent-config-generation/02-RESEARCH.md
@.planning/phases/02-agent-config-generation/02-01-SUMMARY.md
@src/claude_teams/spawner.py
@src/claude_teams/server.py
@src/claude_teams/config_gen.py
@tests/test_spawner.py
@tests/test_server.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire config generation into spawn_teammate and add cleanup</name>
  <files>src/claude_teams/spawner.py, src/claude_teams/server.py</files>
  <action>
    **spawner.py changes:**

    1. Add import at top: `from claude_teams.config_gen import generate_agent_config, write_agent_config, ensure_opencode_json`

    2. Add `project_dir: Path | None = None` keyword-only parameter to `spawn_teammate()` function signature (after `base_dir`).

    3. In `spawn_teammate()`, AFTER the messaging setup (after `messaging.append_message(...)`) and BEFORE the `build_spawn_command()` call, add config generation:
       ```python
       # Generate agent config for OpenCode
       project = project_dir or Path.cwd()
       config_content = generate_agent_config(
           agent_id=member.agent_id,
           name=name,
           team_name=team_name,
           color=color,
           model=model,
       )
       write_agent_config(project, name, config_content)
       ensure_opencode_json(project, mcp_server_command=["claude-teams"])
       ```

    4. Add a new function `cleanup_agent_config(project_dir: Path, name: str) -> None` that deletes `.opencode/agents/<name>.md` if it exists. Use `(project_dir / ".opencode" / "agents" / f"{name}.md").unlink(missing_ok=True)`. This is a simple utility, NOT in config_gen.py, because cleanup is a spawner concern (lifecycle management).

    **server.py changes:**

    1. Add import: `from claude_teams.spawner import cleanup_agent_config` (add to existing spawner import line).

    2. In `force_kill_teammate()`: After `tasks.reset_owner_tasks(team_name, agent_name)`, add cleanup call. Since we don't have project_dir in server context yet, use `Path.cwd()` as default:
       ```python
       cleanup_agent_config(Path.cwd(), agent_name)
       ```
       Add `from pathlib import Path` import if not already present.

    3. In `process_shutdown_approved()`: After `tasks.reset_owner_tasks(team_name, agent_name)`, add the same cleanup:
       ```python
       cleanup_agent_config(Path.cwd(), agent_name)
       ```

    4. In `spawn_teammate_tool()`: Pass `project_dir=Path.cwd()` to the `spawn_teammate()` call so the config files are written relative to the current working directory (where the MCP server runs from).

    **Do NOT modify** `build_spawn_command()` -- that replacement happens in Phase 3.
  </action>
  <verify>
    ```bash
    python -m py_compile src/claude_teams/spawner.py
    python -m py_compile src/claude_teams/server.py
    python -c "from claude_teams.spawner import spawn_teammate, cleanup_agent_config; print('OK')"
    ```
    Verify with grep that:
    - `generate_agent_config` appears in spawner.py
    - `write_agent_config` appears in spawner.py
    - `ensure_opencode_json` appears in spawner.py
    - `cleanup_agent_config` appears in both spawner.py and server.py
    - `project_dir` parameter exists in spawn_teammate signature
  </verify>
  <done>spawn_teammate calls config generation before spawn command; force_kill_teammate and process_shutdown_approved clean up agent config files; all files compile without errors</done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests for config gen wiring</name>
  <files>tests/test_spawner.py, tests/test_server.py</files>
  <action>
    **tests/test_spawner.py -- Add TestConfigGenIntegration class:**

    Add a new test class with tests that verify config generation is called during spawn. These tests must mock subprocess (tmux), shutil.which, and the config_gen functions to avoid side effects. Use `unittest.mock.patch` following existing patterns in the test file.

    Tests to add:

    1. `test_spawn_generates_agent_config(tmp_claude_dir)` -- Patch subprocess.run (for tmux), shutil.which, and validate_opencode_version. Set up a real team with `teams.create_team()`. Call `spawn_teammate()` with `project_dir=tmp_path_for_project`. Assert that `.opencode/agents/<name>.md` exists at the project_dir and contains expected content (YAML frontmatter with mode: primary, permission: allow). Use a separate tmp_path for project_dir (not tmp_claude_dir).

    2. `test_spawn_creates_opencode_json(tmp_claude_dir)` -- Same setup as above. Assert that `opencode.json` exists at the project_dir and contains claude-teams MCP server entry with type=local and command=["claude-teams"].

    3. `test_cleanup_agent_config_removes_file(tmp_path)` -- Create a fake `.opencode/agents/test-agent.md` file. Call `cleanup_agent_config(tmp_path, "test-agent")`. Assert file no longer exists.

    4. `test_cleanup_agent_config_noop_if_missing(tmp_path)` -- Call `cleanup_agent_config(tmp_path, "nonexistent")`. Assert no error raised (missing_ok=True behavior).

    **tests/test_server.py -- Add TestConfigCleanup class:**

    Tests to verify server-level cleanup calls config cleanup:

    1. `test_force_kill_cleans_up_agent_config` -- Patch `cleanup_agent_config` in the server module. Set up team with active member. Call `force_kill_teammate` tool. Assert `cleanup_agent_config` was called with the agent name.

    2. `test_process_shutdown_cleans_up_agent_config` -- Patch `cleanup_agent_config` in the server module. Set up team with member. Call `process_shutdown_approved` tool. Assert `cleanup_agent_config` was called with the agent name.

    Follow existing test patterns:
    - Use `tmp_claude_dir` fixture for team data isolation
    - Use `unittest.mock.patch` for mocking
    - Test class naming: `TestClassName`
    - Descriptive test method names
  </action>
  <verify>
    ```bash
    python -m py_compile tests/test_spawner.py
    python -m py_compile tests/test_server.py

    # Count new tests (expect at least 6 new tests)
    grep -c "def test_" tests/test_spawner.py
    grep -c "def test_" tests/test_server.py
    ```
    Note: Full test execution may be blocked by fcntl import on Windows (known blocker). Verify syntax compilation succeeds and test structure is correct.
  </verify>
  <done>At least 6 new tests added across test_spawner.py and test_server.py covering config generation during spawn, opencode.json creation during spawn, config cleanup on kill, config cleanup on shutdown, and cleanup no-op when file missing. All test files compile without syntax errors.</done>
</task>

</tasks>

<verification>
```bash
# All source files compile
python -m py_compile src/claude_teams/spawner.py
python -m py_compile src/claude_teams/server.py
python -m py_compile src/claude_teams/config_gen.py

# All test files compile
python -m py_compile tests/test_spawner.py
python -m py_compile tests/test_server.py
python -m py_compile tests/test_config_gen.py

# Imports work
python -c "from claude_teams.spawner import spawn_teammate, cleanup_agent_config; print('spawn OK')"
python -c "from claude_teams.config_gen import generate_agent_config, write_agent_config, ensure_opencode_json; print('config_gen OK')"

# Config gen is wired into spawn flow
grep "generate_agent_config" src/claude_teams/spawner.py
grep "write_agent_config" src/claude_teams/spawner.py
grep "ensure_opencode_json" src/claude_teams/spawner.py
grep "cleanup_agent_config" src/claude_teams/server.py
```
</verification>

<success_criteria>
- spawn_teammate() calls generate_agent_config(), write_agent_config(), and ensure_opencode_json() before executing the spawn command
- spawn_teammate() accepts project_dir parameter
- force_kill_teammate and process_shutdown_approved clean up .opencode/agents/<name>.md
- All new behavior covered by tests
- All files compile without syntax errors
- No existing functionality broken (no modifications to existing function signatures that would break callers)
</success_criteria>

<output>
After completion, create `.planning/phases/02-agent-config-generation/02-02-SUMMARY.md`
</output>
