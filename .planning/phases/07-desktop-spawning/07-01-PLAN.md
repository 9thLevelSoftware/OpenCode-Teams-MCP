---
phase: 07-desktop-spawning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/claude_teams/spawner.py
  - src/claude_teams/models.py
  - tests/test_spawner.py
autonomous: true

must_haves:
  truths:
    - "discover_desktop_binary() finds the desktop app on known paths, env var override, or PATH fallback"
    - "discover_desktop_binary() raises FileNotFoundError when the desktop app is not installed"
    - "launch_desktop_app() returns the process PID from subprocess.Popen"
    - "launch_desktop_app() uses CREATE_NEW_PROCESS_GROUP on Windows and start_new_session on POSIX"
    - "check_process_alive() returns True for a running PID and False for a dead/invalid PID"
    - "kill_desktop_process() sends SIGTERM to the process and does not raise on already-dead processes"
    - "TeammateMember has a process_id field (default 0) that is serialized as processId in JSON"
  artifacts:
    - path: "src/claude_teams/spawner.py"
      provides: "Desktop discovery, launch, liveness check, and kill functions"
      contains: "discover_desktop_binary"
    - path: "src/claude_teams/models.py"
      provides: "TeammateMember with process_id field"
      contains: "process_id"
    - path: "tests/test_spawner.py"
      provides: "Tests for all desktop lifecycle functions"
      contains: "TestDesktopDiscovery"
  key_links:
    - from: "src/claude_teams/spawner.py"
      to: "subprocess.Popen"
      via: "launch_desktop_app creates detached process"
      pattern: "subprocess\\.Popen"
    - from: "src/claude_teams/spawner.py"
      to: "os.kill"
      via: "check_process_alive and kill_desktop_process use signal 0 and SIGTERM"
      pattern: "os\\.kill\\(pid"
---

<objective>
Add desktop app discovery, process launch with PID tracking, process liveness checking, and process termination functions. Also extend TeammateMember with a process_id field for desktop backend tracking.

Purpose: Provides the foundational primitives needed to spawn and manage OpenCode desktop app processes as an alternative to tmux panes. Plan 02 wires these into the spawn flow and MCP tools.

Output: New desktop lifecycle functions in spawner.py, updated TeammateMember model, comprehensive tests.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-desktop-spawning/07-RESEARCH.md
@src/claude_teams/spawner.py
@src/claude_teams/models.py
@tests/test_spawner.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add process_id field to TeammateMember and desktop lifecycle functions to spawner.py</name>
  <files>src/claude_teams/models.py, src/claude_teams/spawner.py</files>
  <action>
**1. Extend TeammateMember in `src/claude_teams/models.py`:**

Add a `process_id` field after `backend_type`:
```python
process_id: int = Field(alias="processId", default=0)
```

This field stores the desktop process PID (0 means not launched via desktop). The `tmux_pane_id` field continues to be used for tmux backend. The existing `backend_type` field ("tmux" or "desktop") tells the system which field to use.

**2. Add desktop constants and functions to `src/claude_teams/spawner.py`:**

Add these imports at the top (alongside existing imports):
```python
import os
import signal
import sys
```

Add desktop binary discovery constants after the existing `_PROVIDER_ENV_VARS` dict (around line 89):
```python
# Desktop app binary discovery constants
DESKTOP_BINARY_ENV_VAR = "OPENCODE_DESKTOP_BINARY"

DESKTOP_PATHS: dict[str, list[str]] = {
    "darwin": [
        "/Applications/OpenCode Desktop.app/Contents/MacOS/OpenCode Desktop",
        str(Path.home() / "Applications/OpenCode Desktop.app/Contents/MacOS/OpenCode Desktop"),
    ],
    "win32": [
        str(Path.home() / "AppData/Local/Programs/opencode-desktop/opencode-desktop.exe"),
        str(Path.home() / "AppData/Local/opencode-desktop/opencode-desktop.exe"),
    ],
    "linux": [
        "/usr/bin/opencode-desktop",
        str(Path.home() / ".local/bin/opencode-desktop"),
    ],
}

DESKTOP_BINARY_NAMES: dict[str, list[str]] = {
    "darwin": ["opencode-desktop"],
    "win32": ["opencode-desktop.exe", "opencode-desktop"],
    "linux": ["opencode-desktop", "OpenCode-Desktop.AppImage"],
}
```

Add these four functions after the existing `discover_opencode_binary()` function (before `validate_opencode_version`):

```python
def discover_desktop_binary() -> str:
    """Discover the OpenCode Desktop binary on the current platform.

    Discovery order:
    1. OPENCODE_DESKTOP_BINARY environment variable (explicit override)
    2. Known installation paths for the current platform
    3. PATH search via shutil.which

    Returns:
        Path to the desktop binary.

    Raises:
        FileNotFoundError: If the desktop app is not found.
    """
    # 1. Environment variable override
    env_path = os.environ.get(DESKTOP_BINARY_ENV_VAR)
    if env_path:
        p = Path(env_path)
        if p.exists() and p.is_file():
            return str(p)
        raise FileNotFoundError(
            f"{DESKTOP_BINARY_ENV_VAR} is set to {env_path!r} but the file does not exist"
        )

    platform = sys.platform

    # 2. Known installation paths
    for path_str in DESKTOP_PATHS.get(platform, []):
        p = Path(path_str)
        if p.exists() and p.is_file():
            return str(p)

    # 3. PATH fallback
    for name in DESKTOP_BINARY_NAMES.get(platform, ["opencode-desktop"]):
        found = shutil.which(name)
        if found:
            return found

    raise FileNotFoundError(
        f"Could not find OpenCode Desktop on {platform}. "
        f"Install from https://opencode.ai/download or set {DESKTOP_BINARY_ENV_VAR}"
    )


def launch_desktop_app(binary_path: str, cwd: str) -> int:
    """Launch OpenCode Desktop and return its PID.

    Uses subprocess.Popen for direct process creation to get the actual
    PID. Avoids platform launcher commands (open, start) that don't
    return the real app PID.

    Args:
        binary_path: Path to the desktop binary.
        cwd: Working directory (project root).

    Returns:
        PID of the launched desktop process.
    """
    kwargs: dict = {
        "cwd": cwd,
    }

    if sys.platform == "win32":
        kwargs["creationflags"] = (
            subprocess.CREATE_NEW_PROCESS_GROUP | subprocess.DETACHED_PROCESS
        )
    else:
        kwargs["start_new_session"] = True

    proc = subprocess.Popen([binary_path], **kwargs)
    return proc.pid


def check_process_alive(pid: int) -> bool:
    """Check whether a process with the given PID is still running.

    Cross-platform: uses os.kill(pid, 0) which sends no signal but
    checks process existence. Raises OSError if the process does not
    exist.

    Args:
        pid: Process ID to check.

    Returns:
        True if the process exists, False otherwise.
    """
    if pid <= 0:
        return False
    try:
        os.kill(pid, 0)
        return True
    except (OSError, SystemError):
        return False


def kill_desktop_process(pid: int) -> None:
    """Terminate a desktop process by PID.

    Sends SIGTERM on POSIX or calls TerminateProcess on Windows.
    Does not raise if the process is already dead.

    Args:
        pid: Process ID to terminate.
    """
    if pid <= 0:
        return
    try:
        if sys.platform == "win32":
            os.kill(pid, signal.SIGTERM)
        else:
            os.kill(pid, signal.SIGTERM)
    except (OSError, SystemError):
        pass  # Process already dead
```

**Important notes:**
- Do NOT change `discover_opencode_binary`, `spawn_teammate`, or any existing functions in this task. Those are wired in Plan 02.
- The `os`, `signal`, and `sys` imports may partially overlap with existing imports -- only add what is missing.
  </action>
  <verify>
Run `python -c "from claude_teams.models import TeammateMember; m = TeammateMember(agent_id='a@t', name='a', agent_type='t', model='m', prompt='p', color='c', joined_at=0, tmux_pane_id='', cwd='/tmp'); print(m.process_id); assert m.process_id == 0; d = m.model_dump(by_alias=True); assert 'processId' in d; print('model OK')"` -- confirms process_id field works.

Run `python -c "from claude_teams.spawner import discover_desktop_binary, launch_desktop_app, check_process_alive, kill_desktop_process; print('imports OK')"` -- confirms all functions are importable.
  </verify>
  <done>
TeammateMember has process_id field with default 0 and JSON alias "processId". Four desktop lifecycle functions exist in spawner.py: discover_desktop_binary, launch_desktop_app, check_process_alive, kill_desktop_process. All are importable and have correct signatures.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive tests for desktop lifecycle functions</name>
  <files>tests/test_spawner.py</files>
  <action>
Add test classes to `tests/test_spawner.py`. First, add the new imports at the top alongside existing ones:
```python
from claude_teams.spawner import (
    # ... existing imports ...
    check_process_alive,
    discover_desktop_binary,
    kill_desktop_process,
    launch_desktop_app,
    DESKTOP_BINARY_ENV_VAR,
    DESKTOP_BINARY_NAMES,
    DESKTOP_PATHS,
)
```

Add three new test classes at the end of the file:

**Class TestDesktopDiscovery:**

- `test_env_var_override(self, tmp_path, monkeypatch)`: Create a fake binary at `tmp_path / "opencode-desktop"`, make it a real file (write "fake" to it). Set `OPENCODE_DESKTOP_BINARY` env var via monkeypatch. Call `discover_desktop_binary()`. Assert it returns the path to the fake binary.

- `test_env_var_override_missing_file(self, monkeypatch)`: Set `OPENCODE_DESKTOP_BINARY` to a nonexistent path via monkeypatch. Call `discover_desktop_binary()`. Assert it raises `FileNotFoundError` with a message containing "does not exist".

- `test_known_path_found(self, tmp_path, monkeypatch)`: Monkeypatch `sys.platform` to "linux". Create a fake binary at `tmp_path / "opencode-desktop"`. Monkeypatch `DESKTOP_PATHS` in `claude_teams.spawner` to `{"linux": [str(tmp_path / "opencode-desktop")]}`. Ensure env var is NOT set (monkeypatch.delenv if present). Call `discover_desktop_binary()`. Assert it returns the fake binary path.

- `test_path_fallback(self, monkeypatch)`: Monkeypatch `sys.platform` to "linux". Monkeypatch `DESKTOP_PATHS` to `{"linux": []}` (no known paths). Monkeypatch `shutil.which` to return "/usr/local/bin/opencode-desktop" when called with "opencode-desktop". Ensure env var is NOT set. Call `discover_desktop_binary()`. Assert it returns "/usr/local/bin/opencode-desktop".

- `test_not_found_raises(self, monkeypatch)`: Monkeypatch `sys.platform` to "linux". Monkeypatch `DESKTOP_PATHS` to `{"linux": []}`. Monkeypatch `shutil.which` to return None. Ensure env var is NOT set. Call `discover_desktop_binary()`. Assert it raises `FileNotFoundError` with message containing "Could not find OpenCode Desktop".

**Class TestDesktopLaunch:**

- `test_launch_returns_pid(self, monkeypatch)`: Create a `MagicMock` for `subprocess.Popen`. Set mock's `.pid` to `12345`. Monkeypatch `subprocess.Popen` in `claude_teams.spawner` module. Monkeypatch `sys.platform` to "linux". Call `launch_desktop_app("/usr/bin/opencode-desktop", "/tmp/project")`. Assert return value is `12345`. Assert `subprocess.Popen` was called with `["/usr/bin/opencode-desktop"]` and kwargs containing `cwd="/tmp/project"` and `start_new_session=True`.

- `test_launch_windows_flags(self, monkeypatch)`: Same setup but monkeypatch `sys.platform` to "win32". Call `launch_desktop_app`. Assert `subprocess.Popen` was called with `creationflags` containing `subprocess.CREATE_NEW_PROCESS_GROUP` and `subprocess.DETACHED_PROCESS`. Assert `start_new_session` is NOT in kwargs.

**Class TestProcessLifecycle:**

- `test_check_alive_with_running_process(self, monkeypatch)`: Monkeypatch `os.kill` to not raise. Call `check_process_alive(1234)`. Assert returns True.

- `test_check_alive_with_dead_process(self, monkeypatch)`: Monkeypatch `os.kill` to raise `OSError`. Call `check_process_alive(1234)`. Assert returns False.

- `test_check_alive_with_zero_pid(self)`: Call `check_process_alive(0)`. Assert returns False.

- `test_check_alive_with_negative_pid(self)`: Call `check_process_alive(-1)`. Assert returns False.

- `test_kill_desktop_process(self, monkeypatch)`: Create a MagicMock for `os.kill`. Monkeypatch it. Call `kill_desktop_process(5678)`. Assert `os.kill` was called once with `(5678, signal.SIGTERM)`.

- `test_kill_desktop_process_already_dead(self, monkeypatch)`: Monkeypatch `os.kill` to raise `OSError`. Call `kill_desktop_process(5678)`. Assert no exception raised (function swallows it).

- `test_kill_desktop_process_zero_pid(self, monkeypatch)`: Create a MagicMock for `os.kill`. Monkeypatch it. Call `kill_desktop_process(0)`. Assert `os.kill` was NOT called.

All tests should import `signal` and `os` as needed.
  </action>
  <verify>
Run `python -m pytest tests/test_spawner.py::TestDesktopDiscovery -v` -- 5 tests pass.
Run `python -m pytest tests/test_spawner.py::TestDesktopLaunch -v` -- 2 tests pass.
Run `python -m pytest tests/test_spawner.py::TestProcessLifecycle -v` -- 7 tests pass.
Run `python -m pytest tests/test_spawner.py -v` -- all tests pass (existing + 14 new).
  </verify>
  <done>
14 new tests covering desktop binary discovery (env var, known paths, PATH fallback, not found), desktop app launch (PID return, Windows flags), and process lifecycle (alive check, kill, edge cases). All existing spawner tests still pass.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_spawner.py -v` -- all tests pass (existing + 14 new)
2. `python -c "from claude_teams.models import TeammateMember; m = TeammateMember(agent_id='a@t', name='a', agent_type='t', model='m', prompt='p', color='c', joined_at=0, tmux_pane_id='', cwd='/tmp'); assert m.process_id == 0; assert m.backend_type == 'tmux'; d = m.model_dump(by_alias=True); assert 'processId' in d; print('model OK')"` -- model field works
3. `python -c "import inspect; from claude_teams.spawner import discover_desktop_binary, launch_desktop_app, check_process_alive, kill_desktop_process; print('all 4 desktop functions importable')"` -- functions exist
4. `python -m pytest tests/ -v` -- full test suite passes
</verification>

<success_criteria>
- TeammateMember has process_id field with default 0, alias "processId"
- discover_desktop_binary() uses 3-tier discovery: env var, known paths, PATH fallback
- launch_desktop_app() launches via Popen with platform-specific detach flags and returns PID
- check_process_alive() uses os.kill(pid, 0) for cross-platform liveness check
- kill_desktop_process() sends SIGTERM and swallows errors for already-dead processes
- 14 new tests covering all desktop lifecycle functions
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-desktop-spawning/07-01-SUMMARY.md`
</output>
