---
phase: 07-desktop-spawning
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/claude_teams/spawner.py
  - src/claude_teams/server.py
  - tests/test_spawner.py
  - tests/test_server.py
autonomous: true

must_haves:
  truths:
    - "spawn_teammate accepts backend_type='desktop' and desktop_binary params and launches via launch_desktop_app instead of tmux"
    - "spawn_teammate with backend_type='desktop' stores the PID in process_id field and sets backend_type='desktop' on the member"
    - "spawn_teammate with backend_type='tmux' (default) preserves existing behavior -- no regression"
    - "spawn_teammate_tool accepts a backend parameter (default 'tmux') and passes it to spawn_teammate"
    - "spawn_teammate_tool with backend='desktop' discovers the desktop binary and passes it to spawn_teammate"
    - "force_kill_teammate branches on backend_type: tmux uses kill_tmux_pane, desktop uses kill_desktop_process"
    - "check_single_agent_health branches on backend_type: tmux uses pane checks, desktop uses process alive check (no hung detection)"
    - "Desktop-spawned agent health returns 'alive' or 'dead' only (no 'hung' status)"
  artifacts:
    - path: "src/claude_teams/spawner.py"
      provides: "spawn_teammate with desktop backend path, desktop-aware health check"
      contains: "backend_type.*desktop"
    - path: "src/claude_teams/server.py"
      provides: "spawn_teammate_tool with backend param, desktop-aware force_kill and health tools"
      contains: "backend.*desktop"
    - path: "tests/test_spawner.py"
      provides: "Tests for desktop spawn flow and desktop health checks"
      contains: "TestSpawnDesktopBackend"
    - path: "tests/test_server.py"
      provides: "MCP integration tests for desktop backend parameter"
      contains: "TestSpawnDesktopBackendTool"
  key_links:
    - from: "src/claude_teams/spawner.py"
      to: "src/claude_teams/spawner.py"
      via: "spawn_teammate calls launch_desktop_app when backend_type='desktop'"
      pattern: "launch_desktop_app\\("
    - from: "src/claude_teams/server.py"
      to: "src/claude_teams/spawner.py"
      via: "spawn_teammate_tool passes backend_type and desktop_binary to spawn_teammate"
      pattern: "backend_type=.*desktop_binary="
    - from: "src/claude_teams/server.py"
      to: "src/claude_teams/spawner.py"
      via: "force_kill_teammate calls kill_desktop_process for desktop backend"
      pattern: "kill_desktop_process\\("
---

<objective>
Wire the desktop spawn path into spawn_teammate, branch force_kill and health checks by backend_type, and expose the backend parameter via MCP tools.

Purpose: Completes the desktop spawning integration so that MCP clients can choose to spawn agents as desktop apps instead of CLI tmux panes, with full lifecycle management (spawn, health check, kill).

Output: Modified spawner.py with desktop backend in spawn flow, modified server.py with backend parameter, comprehensive tests.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-desktop-spawning/07-RESEARCH.md
@.planning/phases/07-desktop-spawning/07-01-SUMMARY.md
@src/claude_teams/spawner.py
@src/claude_teams/server.py
@src/claude_teams/models.py
@tests/test_spawner.py
@tests/test_server.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add desktop backend path to spawn_teammate and branch health/kill functions</name>
  <files>src/claude_teams/spawner.py, tests/test_spawner.py</files>
  <action>
**1. Modify `spawn_teammate()` in `src/claude_teams/spawner.py`:**

Add two keyword-only parameters after `custom_instructions`:
```python
def spawn_teammate(
    team_name: str,
    name: str,
    prompt: str,
    opencode_binary: str,
    lead_session_id: str,
    *,
    model: str = "sonnet",
    subagent_type: str = "general-purpose",
    role_instructions: str = "",
    custom_instructions: str = "",
    backend_type: str = "tmux",         # NEW: "tmux" or "desktop"
    desktop_binary: str | None = None,  # NEW: path to desktop app binary
    cwd: str | None = None,
    plan_mode_required: bool = False,
    base_dir: Path | None = None,
    project_dir: Path | None = None,
) -> TeammateMember:
```

Change the member creation to use the `backend_type` parameter:
```python
member = TeammateMember(
    # ... existing fields ...
    backend_type=backend_type,  # was hardcoded to "tmux"
    is_active=False,
)
```

Replace the tmux-only spawn block (lines 226-233) with a backend-branching block:
```python
if backend_type == "desktop":
    if not desktop_binary:
        raise ValueError("desktop_binary is required when backend_type='desktop'")
    pid = launch_desktop_app(desktop_binary, member.cwd)
    # Store PID in process_id field
    config = teams.read_config(team_name, base_dir)
    for m in config.members:
        if isinstance(m, TeammateMember) and m.name == name:
            m.process_id = pid
            m.backend_type = "desktop"
            break
    teams.write_config(team_name, config, base_dir)
    member.process_id = pid
else:
    # Existing tmux spawn path
    cmd = build_opencode_run_command(member, opencode_binary)
    result = subprocess.run(
        ["tmux", "split-window", "-dP", "-F", "#{pane_id}", cmd],
        capture_output=True,
        text=True,
        check=True,
    )
    pane_id = result.stdout.strip()

    config = teams.read_config(team_name, base_dir)
    for m in config.members:
        if isinstance(m, TeammateMember) and m.name == name:
            m.tmux_pane_id = pane_id
            break
    teams.write_config(team_name, config, base_dir)
    member.tmux_pane_id = pane_id
```

Remove the duplicate config update block that was after the old tmux-only block (lines 235-240), since both branches now handle their own config update.

Return `member` as before.

**2. Modify `check_single_agent_health()` to branch on backend_type:**

At the top of the function, check `member.backend_type`:
```python
def check_single_agent_health(
    member: TeammateMember,
    previous_hash: str | None,
    last_change_time: float | None,
    hung_timeout: int = DEFAULT_HUNG_TIMEOUT_SECONDS,
    grace_period: int = DEFAULT_GRACE_PERIOD_SECONDS,
) -> AgentHealthStatus:
    # Desktop backend: process-based liveness only, no hung detection
    if member.backend_type == "desktop":
        pid = member.process_id
        if not check_process_alive(pid):
            return AgentHealthStatus(
                agent_name=member.name,
                pane_id=str(pid),
                status="dead",
                detail="Desktop process is no longer running",
            )
        return AgentHealthStatus(
            agent_name=member.name,
            pane_id=str(pid),
            status="alive",
            detail="Desktop process is running",
        )

    # Tmux backend: existing logic (unchanged)
    pane_id = member.tmux_pane_id
    # ... rest of existing function unchanged ...
```

**3. Add tests to `tests/test_spawner.py`:**

**Class TestSpawnDesktopBackend:**

- `test_spawn_desktop_calls_launch_desktop_app(self, team_dir, tmp_path)`: Mock `claude_teams.spawner.launch_desktop_app` to return PID 9999. Mock `subprocess.run` (to prevent tmux calls). Call `spawn_teammate(...)` with `backend_type="desktop"`, `desktop_binary="/fake/opencode-desktop"`, `base_dir=team_dir`, `project_dir=tmp_path / "project"`. Assert `launch_desktop_app` was called once with `("/fake/opencode-desktop", ANY)`. Assert returned member has `process_id == 9999` and `backend_type == "desktop"`.

- `test_spawn_desktop_requires_desktop_binary(self, team_dir, tmp_path)`: Call `spawn_teammate(...)` with `backend_type="desktop"` but WITHOUT `desktop_binary`. Assert raises `ValueError` with message containing "desktop_binary is required".

- `test_spawn_desktop_stores_pid_in_config(self, team_dir, tmp_path)`: Mock `launch_desktop_app` to return 8888. Call `spawn_teammate` with desktop backend. Read back the team config via `teams.read_config()`. Find the member and assert `m.process_id == 8888` and `m.backend_type == "desktop"`.

- `test_spawn_tmux_still_works(self, team_dir, tmp_path)`: Mock `subprocess.run` as before. Call `spawn_teammate(...)` with default `backend_type="tmux"`. Assert the tmux split-window command was called. Assert returned member has `tmux_pane_id` set (not empty) and `backend_type == "tmux"`.

**Class TestDesktopHealthCheck:**

- `test_desktop_alive(self, monkeypatch)`: Create a TeammateMember with `backend_type="desktop"`, `process_id=1234`. Monkeypatch `check_process_alive` to return True. Call `check_single_agent_health(member, None, None)`. Assert status == "alive" and detail contains "running".

- `test_desktop_dead(self, monkeypatch)`: Same setup but `check_process_alive` returns False. Assert status == "dead" and detail contains "no longer running".

- `test_desktop_never_reports_hung(self, monkeypatch)`: Create a TeammateMember with `backend_type="desktop"`, `process_id=1234`. Monkeypatch `check_process_alive` to return True. Call `check_single_agent_health(member, "samehash", "samehash", time.time() - 300, 120)` (simulating conditions that would trigger "hung" for tmux). Assert status is "alive" (NOT "hung"), proving desktop backend skips hung detection.

Follow existing test patterns: use `@patch("claude_teams.spawner.subprocess")`, create team with `teams.create_team()`, pass `base_dir=tmp_claude_dir` and `project_dir=tmp_path/"project"`.
  </action>
  <verify>
Run `python -m pytest tests/test_spawner.py::TestSpawnDesktopBackend -v` -- 4 tests pass.
Run `python -m pytest tests/test_spawner.py::TestDesktopHealthCheck -v` -- 3 tests pass.
Run `python -m pytest tests/test_spawner.py -v` -- all tests pass (existing + new).
  </verify>
  <done>
spawn_teammate supports backend_type="desktop" with PID tracking via process_id. Desktop health check returns alive/dead based on process liveness, no hung detection. Tmux path is unchanged (no regression). 7 new spawner tests pass. All existing tests still pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire backend param into MCP tools and branch force_kill/health by backend_type</name>
  <files>src/claude_teams/server.py, tests/test_server.py</files>
  <action>
**1. Update imports in `src/claude_teams/server.py`:**

Add new imports from spawner:
```python
from claude_teams.spawner import (
    # ... existing imports ...
    check_process_alive,
    discover_desktop_binary,
    kill_desktop_process,
    launch_desktop_app,
)
```

**2. Modify `spawn_teammate_tool`:**

Add a `backend` parameter:
```python
@mcp.tool(name="spawn_teammate")
def spawn_teammate_tool(
    team_name: str,
    name: str,
    prompt: str,
    ctx: Context,
    model: str = "sonnet",
    template: str = "",
    custom_instructions: str = "",
    plan_mode_required: bool = False,
    backend: str = "tmux",  # NEW: "tmux" or "desktop"
) -> dict:
    """Spawn a new OpenCode teammate. By default spawns in a tmux pane (CLI).
    Set backend='desktop' to launch the OpenCode desktop app instead.
    The teammate receives its initial prompt via inbox and begins working
    autonomously. Names must be unique within the team. Use template to assign
    a role (researcher, implementer, reviewer, tester). Use list_agent_templates
    to see available templates."""
```

Add desktop binary discovery before the spawn call when backend is "desktop":
```python
    # Desktop binary discovery
    desktop_binary = None
    if backend == "desktop":
        try:
            desktop_binary = discover_desktop_binary()
        except FileNotFoundError as e:
            raise ToolError(str(e))

    member = spawn_teammate(
        team_name=team_name,
        name=name,
        prompt=prompt,
        opencode_binary=ls["opencode_binary"],
        lead_session_id=ls["session_id"],
        model=resolved_model,
        subagent_type=template or "general-purpose",
        role_instructions=role_instructions,
        custom_instructions=custom_instructions,
        backend_type=backend,
        desktop_binary=desktop_binary,
        plan_mode_required=plan_mode_required,
        project_dir=Path.cwd(),
    )
```

**3. Modify `force_kill_teammate` to branch on backend_type:**

```python
@mcp.tool
def force_kill_teammate(team_name: str, agent_name: str) -> dict:
    """Forcibly kill a teammate. For tmux backend, kills the tmux pane.
    For desktop backend, terminates the desktop process. Removes member
    from config and resets their tasks."""
    config = teams.read_config(team_name)
    member = None
    for m in config.members:
        if isinstance(m, TeammateMember) and m.name == agent_name:
            member = m
            break
    if member is None:
        raise ToolError(f"Teammate {agent_name!r} not found in team {team_name!r}")

    if member.backend_type == "desktop":
        if member.process_id:
            kill_desktop_process(member.process_id)
    else:
        if member.tmux_pane_id:
            kill_tmux_pane(member.tmux_pane_id)

    teams.remove_member(team_name, agent_name)
    tasks.reset_owner_tasks(team_name, agent_name)
    cleanup_agent_config(Path.cwd(), agent_name)
    return {"success": True, "message": f"{agent_name} has been stopped."}
```

**4. No changes needed to health check tools** -- they call `check_single_agent_health` which already branches on backend_type from Task 1. The health tools pass the full member object which now includes `backend_type` and `process_id`.

**5. Add tests to `tests/test_server.py`:**

**Class TestSpawnDesktopBackendTool:**

- `test_spawn_with_desktop_backend(self, client)`: Mock `spawn_teammate` in `claude_teams.server` (as in TestModelTranslationWiring pattern). Mock `discover_desktop_binary` to return "/fake/desktop". Call `spawn_teammate_tool` with `backend="desktop"`. Assert `spawn_teammate` was called with `backend_type="desktop"` and `desktop_binary="/fake/desktop"`.

- `test_spawn_with_tmux_backend_default(self, client)`: Mock `spawn_teammate`. Call `spawn_teammate_tool` without `backend` param. Assert `spawn_teammate` was called with `backend_type="tmux"` and `desktop_binary=None`.

- `test_spawn_desktop_discovery_failure(self, client)`: Mock `discover_desktop_binary` to raise `FileNotFoundError("not found")`. Call `spawn_teammate_tool` with `backend="desktop"` using `raise_on_error=False`. Assert `is_error` is True and response text contains "not found".

**Class TestForceKillDesktopBackend:**

- `test_force_kill_desktop_agent(self, client)`: Create a team, manually add a TeammateMember with `backend_type="desktop"` and `process_id=5555`. Mock `kill_desktop_process`. Call `force_kill_teammate` tool. Assert `kill_desktop_process` was called with `5555`. Assert `kill_tmux_pane` was NOT called.

- `test_force_kill_tmux_agent_unchanged(self, client)`: Create a team, manually add a TeammateMember with `backend_type="tmux"` and `tmux_pane_id="%42"`. Mock `kill_tmux_pane`. Call `force_kill_teammate` tool. Assert `kill_tmux_pane` was called with `"%42"`. Assert `kill_desktop_process` was NOT called.

Follow existing test patterns: use `unittest.mock.patch("claude_teams.server.spawn_teammate")` for spawn mocking, direct team/member creation for kill tests.
  </action>
  <verify>
Run `python -m pytest tests/test_server.py::TestSpawnDesktopBackendTool -v` -- 3 tests pass.
Run `python -m pytest tests/test_server.py::TestForceKillDesktopBackend -v` -- 2 tests pass.
Run `python -m pytest tests/test_server.py -v` -- all tests pass (existing + 5 new).
Run `python -m pytest tests/ -v` -- full test suite passes.
  </verify>
  <done>
spawn_teammate_tool accepts backend="desktop" parameter and discovers the desktop binary before spawning. force_kill_teammate branches on backend_type to use kill_desktop_process or kill_tmux_pane. Health check already branches via check_single_agent_health from Task 1. 5 new server tests pass. All existing tests still pass. Full test suite green.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_spawner.py tests/test_server.py -v` -- all tests pass
2. `python -m pytest tests/ -v` -- full test suite passes
3. Verify desktop spawn signature: `python -c "import inspect; from claude_teams.spawner import spawn_teammate; sig = inspect.signature(spawn_teammate); assert 'backend_type' in sig.parameters; assert 'desktop_binary' in sig.parameters; print('spawn params OK')"`
4. Verify MCP tool has backend param: `python -c "import inspect; from claude_teams.server import spawn_teammate_tool; sig = inspect.signature(spawn_teammate_tool); assert 'backend' in sig.parameters; print('tool params OK')"`
5. Verify force_kill imports: `python -c "from claude_teams.server import force_kill_teammate; print('force_kill OK')"`
</verification>

<success_criteria>
- spawn_teammate() accepts backend_type="desktop" and desktop_binary params
- Desktop backend uses launch_desktop_app for process creation and stores PID in process_id
- Tmux backend path is completely unchanged (no regression)
- spawn_teammate_tool() accepts backend parameter (default "tmux")
- Desktop binary is discovered at spawn time when backend="desktop"
- force_kill_teammate branches: tmux -> kill_tmux_pane, desktop -> kill_desktop_process
- check_single_agent_health branches: tmux -> pane checks + hung detection, desktop -> process alive only
- Desktop health never reports "hung" (no content hash equivalent)
- All existing tests pass unchanged
- All new tests pass
- Full test suite has zero failures
</success_criteria>

<output>
After completion, create `.planning/phases/07-desktop-spawning/07-02-SUMMARY.md`
</output>
