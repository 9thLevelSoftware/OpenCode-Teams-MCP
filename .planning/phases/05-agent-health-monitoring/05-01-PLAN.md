---
phase: 05-agent-health-monitoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/claude_teams/models.py
  - src/claude_teams/spawner.py
  - tests/test_spawner.py
autonomous: true

must_haves:
  truths:
    - "check_pane_alive() returns True for a live pane and False for a dead/missing pane"
    - "capture_pane_content_hash() returns a SHA-256 digest for a live pane and None for a missing pane"
    - "check_single_agent_health() returns 'dead' when pane is gone, 'alive' when pane is active, 'hung' when content is unchanged beyond timeout, and respects grace period for newly spawned agents"
    - "Health state is persisted to ~/.claude/teams/<name>/health.json and loaded between calls"
  artifacts:
    - path: "src/claude_teams/models.py"
      provides: "AgentHealthStatus Pydantic model"
      contains: "class AgentHealthStatus"
    - path: "src/claude_teams/spawner.py"
      provides: "check_pane_alive, capture_pane_content_hash, check_single_agent_health, load_health_state, save_health_state"
      contains: "def check_pane_alive"
    - path: "tests/test_spawner.py"
      provides: "Tests for all health detection functions"
      contains: "class TestCheckPaneAlive"
  key_links:
    - from: "src/claude_teams/spawner.py"
      to: "tmux display-message"
      via: "subprocess.run"
      pattern: 'tmux.*display-message.*pane_dead'
    - from: "src/claude_teams/spawner.py"
      to: "tmux capture-pane"
      via: "subprocess.run"
      pattern: 'tmux.*capture-pane'
    - from: "src/claude_teams/spawner.py"
      to: "src/claude_teams/models.py"
      via: "AgentHealthStatus import"
      pattern: "from claude_teams.models import.*AgentHealthStatus"
---

<objective>
Add agent health detection functions: pane liveness check via tmux, content hashing for hung detection, and a combined health check function with grace period and timeout support.

Purpose: Satisfy RELY-03 (detect dead/hung agents via tmux pane status). These are the core building blocks that the MCP tools in Plan 05-02 will expose.
Output: AgentHealthStatus model, check_pane_alive(), capture_pane_content_hash(), check_single_agent_health(), health state persistence functions, and comprehensive tests.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-agent-health-monitoring/05-RESEARCH.md
@src/claude_teams/models.py
@src/claude_teams/spawner.py
@tests/test_spawner.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AgentHealthStatus model and core detection functions</name>
  <files>src/claude_teams/models.py, src/claude_teams/spawner.py</files>
  <action>
**In src/claude_teams/models.py**, add the `AgentHealthStatus` model after the existing `SendMessageResult` class:

```python
class AgentHealthStatus(BaseModel):
    model_config = {"populate_by_name": True}

    agent_name: str = Field(alias="agentName")
    pane_id: str = Field(alias="paneId")
    status: Literal["alive", "dead", "hung", "unknown"]
    last_content_hash: str | None = Field(alias="lastContentHash", default=None)
    detail: str = ""
```

**In src/claude_teams/spawner.py**, add the following imports at the top: `hashlib`. Then add these constants and functions after the existing `cleanup_agent_config` function and before the OpenCode binary discovery section:

1. **Constants:**
   ```python
   DEFAULT_HUNG_TIMEOUT_SECONDS = 120
   DEFAULT_GRACE_PERIOD_SECONDS = 60
   ```

2. **`check_pane_alive(pane_id: str) -> bool`:** Uses `tmux display-message -p -t <pane_id> '#{pane_dead}'`. Returns True if pane exists and `pane_dead == "0"`. Returns False if pane doesn't exist (non-zero returncode) or `pane_dead == "1"`. Handle empty pane_id (return False), `subprocess.TimeoutExpired`, and `FileNotFoundError` (tmux not installed). Use `timeout=5` on subprocess.run.

3. **`capture_pane_content_hash(pane_id: str) -> str | None`:** Uses `tmux capture-pane -p -t <pane_id>` (visible content only, NO `-S-` flag to avoid known hangs). Returns `hashlib.sha256(result.stdout.encode()).hexdigest()` on success, `None` on failure. Handle empty pane_id, TimeoutExpired, FileNotFoundError. Use `timeout=5`.

4. **`load_health_state(team_name: str, base_dir: Path | None = None) -> dict`:** Load health state from `~/.claude/teams/<team_name>/health.json`. Returns a dict keyed by agent name, each value is `{"hash": str, "last_change_time": float}`. If file doesn't exist, returns empty dict. Use `teams.TEAMS_DIR` logic for base_dir resolution (same pattern as `teams.read_config`).

5. **`save_health_state(team_name: str, state: dict, base_dir: Path | None = None) -> None`:** Write health state dict to `~/.claude/teams/<team_name>/health.json`. Use `json.dumps` with indent=2. Follow the base_dir resolution pattern from teams module.

6. **`check_single_agent_health(...)`:** Takes `member: TeammateMember`, `previous_hash: str | None`, `last_change_time: float | None`, `hung_timeout: int = DEFAULT_HUNG_TIMEOUT_SECONDS`, `grace_period: int = DEFAULT_GRACE_PERIOD_SECONDS`. Returns `AgentHealthStatus`. Logic:
   - If `check_pane_alive(member.tmux_pane_id)` is False -> status="dead"
   - If alive, `capture_pane_content_hash()`. If None -> status="unknown"
   - Check grace period: `(time.time() * 1000 - member.joined_at) / 1000 < grace_period` -> status="alive" with grace detail
   - If previous_hash matches current_hash and last_change_time is provided and `time.time() - last_change_time >= hung_timeout` -> status="hung"
   - Otherwise -> status="alive"

Import `AgentHealthStatus` from models. Import `json` for health state file I/O.
  </action>
  <verify>Run `python -c "from claude_teams.models import AgentHealthStatus; from claude_teams.spawner import check_pane_alive, capture_pane_content_hash, check_single_agent_health, load_health_state, save_health_state; print('OK')"` -- should print OK with no import errors.</verify>
  <done>AgentHealthStatus model exists in models.py. check_pane_alive, capture_pane_content_hash, check_single_agent_health, load_health_state, save_health_state exist in spawner.py with correct signatures.</done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive tests for all health detection functions</name>
  <files>tests/test_spawner.py</files>
  <action>
Add the following test classes to `tests/test_spawner.py`. Import `AgentHealthStatus` from `claude_teams.models` and the new functions from `claude_teams.spawner` in the existing import block.

**TestCheckPaneAlive:**
1. `test_returns_true_for_alive_pane` -- mock subprocess.run to return stdout="0\n", returncode=0. Assert True.
2. `test_returns_false_for_dead_pane` -- mock subprocess.run to return stdout="1\n", returncode=0. Assert False.
3. `test_returns_false_for_missing_pane` -- mock subprocess.run to return returncode=1. Assert False.
4. `test_returns_false_for_empty_pane_id` -- call with "". Assert False (no subprocess call).
5. `test_returns_false_on_timeout` -- mock subprocess.run to raise TimeoutExpired. Assert False.
6. `test_returns_false_when_tmux_not_installed` -- mock subprocess.run to raise FileNotFoundError. Assert False.

**TestCapturePaneContentHash:**
1. `test_returns_hash_for_live_pane` -- mock subprocess.run to return stdout="some output\n", returncode=0. Assert result is a 64-char hex string (SHA-256 digest length).
2. `test_returns_none_for_failed_capture` -- mock subprocess.run to return returncode=1. Assert None.
3. `test_returns_none_for_empty_pane_id` -- call with "". Assert None.
4. `test_returns_none_on_timeout` -- mock subprocess.run to raise TimeoutExpired. Assert None.
5. `test_same_content_produces_same_hash` -- verify deterministic hashing.
6. `test_different_content_produces_different_hash` -- verify distinct content hashes differently.

**TestCheckSingleAgentHealth:**
Use `_make_opencode_member()` with `joined_at=int(time.time() * 1000) - 120_000` (2 minutes ago, past grace period) and `tmux_pane_id="%42"`.

1. `test_dead_when_pane_missing` -- mock check_pane_alive to return False. Assert status=="dead".
2. `test_alive_when_pane_exists_and_content_changes` -- mock check_pane_alive=True, capture_pane_content_hash returns "newhash". Pass previous_hash="oldhash". Assert status=="alive".
3. `test_hung_when_content_unchanged_beyond_timeout` -- mock alive=True, hash returns "samehash". Pass previous_hash="samehash", last_change_time=time.time()-130. Assert status=="hung".
4. `test_alive_during_grace_period` -- create member with joined_at=int(time.time()*1000)-5000 (5 seconds ago). Mock alive=True, hash returns "samehash". Pass previous_hash="samehash", last_change_time=time.time()-130. Assert status=="alive" (grace period protects).
5. `test_unknown_when_capture_fails` -- mock alive=True, capture returns None. Assert status=="unknown".
6. `test_alive_when_content_unchanged_within_timeout` -- mock alive=True, hash="samehash", previous_hash="samehash", last_change_time=time.time()-30 (only 30s, below 120s threshold). Assert status=="alive".

**TestHealthStatePersistence:**
1. `test_load_empty_state_when_no_file` -- call load_health_state on a team with no health.json. Assert returns empty dict.
2. `test_save_and_load_round_trip` -- save state with agent hash+timestamp, load it back, assert values match.
3. `test_save_overwrites_previous` -- save state, save different state, load, assert latest values.

Mock `subprocess.run` on the `check_pane_alive` and `capture_pane_content_hash` tests at the `claude_teams.spawner.subprocess.run` path. For `check_single_agent_health` tests, mock `claude_teams.spawner.check_pane_alive` and `claude_teams.spawner.capture_pane_content_hash` directly since we are testing the orchestration logic, not the subprocess calls.

Use the existing `team_dir` fixture for health state persistence tests (it creates a team with directories).
  </action>
  <verify>Run `python -m pytest tests/test_spawner.py -v -k "TestCheckPaneAlive or TestCapturePaneContentHash or TestCheckSingleAgentHealth or TestHealthStatePersistence"` -- all new tests pass.</verify>
  <done>18+ tests pass covering: pane liveness (6 cases), content hashing (6 cases), combined health check (6 cases), health state persistence (3 cases). All edge cases (empty pane_id, timeout, tmux missing, grace period, hung timeout) have explicit test coverage.</done>
</task>

</tasks>

<verification>
1. `python -c "from claude_teams.models import AgentHealthStatus; print(AgentHealthStatus.model_fields.keys())"` shows expected fields
2. `python -m pytest tests/test_spawner.py -v` -- all existing and new tests pass
3. No import errors from new code
4. Health state file round-trip works with real filesystem via tmp_path
</verification>

<success_criteria>
- AgentHealthStatus model with status literals alive/dead/hung/unknown
- check_pane_alive() correctly queries tmux and handles all error cases
- capture_pane_content_hash() returns SHA-256 digest or None
- check_single_agent_health() combines liveness + hung detection with grace period
- Health state persistence via JSON file alongside team config
- All tests pass (18+ new tests)
</success_criteria>

<output>
After completion, create `.planning/phases/05-agent-health-monitoring/05-01-SUMMARY.md`
</output>
