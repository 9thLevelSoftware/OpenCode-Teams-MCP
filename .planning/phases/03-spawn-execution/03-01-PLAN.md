---
phase: 03-spawn-execution
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/claude_teams/spawner.py
  - src/claude_teams/server.py
  - tests/test_spawner.py
autonomous: true

must_haves:
  truths:
    - "build_opencode_run_command() produces a command string containing 'opencode run --agent <name> --model <provider/model> --format json <prompt>' with cd and timeout wrapping"
    - "spawn_teammate() uses opencode_binary parameter (not claude_binary) and calls build_opencode_run_command instead of build_spawn_command"
    - "server.py passes opencode_binary keyword argument matching the renamed parameter"
    - "No Claude Code CLI flags (--agent-id, --team-name, --parent-session-id, --agent-color, --agent-type) or env vars (CLAUDECODE, CLAUDE_CODE_EXPERIMENTAL) appear in the new command"
    - "Spawn commands include 'timeout 300' to prevent indefinite hangs from OpenCode API errors"
  artifacts:
    - path: "src/claude_teams/spawner.py"
      provides: "build_opencode_run_command function replacing build_spawn_command, SPAWN_TIMEOUT_SECONDS constant"
      exports: ["build_opencode_run_command", "SPAWN_TIMEOUT_SECONDS"]
      contains: "def build_opencode_run_command"
    - path: "src/claude_teams/server.py"
      provides: "Updated spawn_teammate call with opencode_binary keyword"
      contains: "opencode_binary=ls"
    - path: "tests/test_spawner.py"
      provides: "Tests for OpenCode command construction, timeout wrapping, absence of Claude flags"
      contains: "TestBuildOpencodeRunCommand"
  key_links:
    - from: "src/claude_teams/spawner.py"
      to: "build_opencode_run_command"
      via: "spawn_teammate calls build_opencode_run_command instead of build_spawn_command"
      pattern: "build_opencode_run_command\\(member"
    - from: "src/claude_teams/server.py"
      to: "src/claude_teams/spawner.py"
      via: "spawn_teammate_tool passes opencode_binary keyword"
      pattern: "opencode_binary=ls\\[.opencode_binary.\\]"
    - from: "src/claude_teams/spawner.py"
      to: "shlex.quote"
      via: "All command components shell-escaped"
      pattern: "shlex\\.quote\\("
---

<objective>
Replace the Claude Code spawn command construction with OpenCode `run` command construction, rename the `claude_binary` parameter to `opencode_binary` across the call chain, and add timeout wrapping to prevent hung processes.

Purpose: This is the core Phase 3 work. Research confirmed that SPAWN-07 (tmux pane creation), SPAWN-08 (pane ID capture), and SPAWN-09 (initial prompt delivery) are already satisfied by existing code. The only new work is SPAWN-06 (command construction) and RELY-01 (timeout wrapping). This plan covers the entire phase in a single TDD cycle.

Output: Working `build_opencode_run_command()` function, updated `spawn_teammate()` signature, updated server.py call site, comprehensive tests.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-spawn-execution/03-RESEARCH.md
@.planning/phases/02-agent-config-generation/02-02-SUMMARY.md
@src/claude_teams/spawner.py
@src/claude_teams/server.py
@src/claude_teams/models.py
@tests/test_spawner.py
</context>

<feature>
  <name>OpenCode Run Command Construction</name>
  <files>src/claude_teams/spawner.py, src/claude_teams/server.py, tests/test_spawner.py</files>
  <behavior>
    build_opencode_run_command(member, opencode_binary) -> str:
      - Input: TeammateMember with name="researcher", model="moonshot-ai/kimi-k2.5", prompt="Do research", cwd="/tmp"
      - Output: "cd '/tmp' && timeout 300 '/usr/local/bin/opencode' run --agent 'researcher' --model 'moonshot-ai/kimi-k2.5' --format json 'Do research'"

    Cases:
      - basic_format: member(name="researcher", model="moonshot-ai/kimi-k2.5") -> contains "opencode run", "--agent researcher", "--model moonshot-ai/kimi-k2.5", "--format json", "timeout 300", "cd /tmp"
      - prompt_quoting: prompt="Fix 'main.py' bugs" -> shlex.quote wraps safely, no shell injection
      - special_chars: prompt='Use "$HOME" and `backticks`' -> content preserved via shlex.quote
      - custom_timeout: timeout_seconds=600 -> contains "timeout 600"
      - no_claude_flags: -> does NOT contain --agent-id, --team-name, --parent-session-id, --agent-color, CLAUDECODE, CLAUDE_CODE_EXPERIMENTAL
      - no_plan_mode_flag: -> --plan-mode-required does NOT appear (OpenCode has no equivalent; handled via agent config)

    spawn_teammate() signature change:
      - Parameter renamed: claude_binary -> opencode_binary
      - Calls build_opencode_run_command(member, opencode_binary) instead of build_spawn_command(member, claude_binary, lead_session_id)
      - lead_session_id still accepted (stored in config) but NOT passed to command

    server.py call site:
      - Changes: claude_binary=ls["opencode_binary"] -> opencode_binary=ls["opencode_binary"]
  </behavior>
  <implementation>
    RED phase - Write tests first:

    1. In tests/test_spawner.py, ADD new test class `TestBuildOpencodeRunCommand` with these tests:
       - test_basic_command_format: Verify output contains "opencode run", "--agent", "--model", "--format json", "timeout 300", "cd"
       - test_prompt_is_shell_quoted: Verify prompt with single quotes is handled by shlex.quote
       - test_special_chars_in_prompt: Verify $, backticks preserved safely
       - test_custom_timeout: Verify timeout_seconds parameter works
       - test_no_claude_flags: Verify NO Claude Code flags (--agent-id, --team-name, --parent-session-id, --agent-color, --agent-type, CLAUDECODE, CLAUDE_CODE_EXPERIMENTAL) appear
       - test_no_plan_mode_flag: Verify --plan-mode-required does NOT appear even if member.plan_mode_required=True

    2. Update existing `TestSpawnTeammate` tests to use `opencode_binary` keyword instead of positional `claude_binary`:
       - All spawn_teammate() calls should pass the binary path as a positional arg (3rd positional stays unchanged since it's positional, not keyword)
       - Note: the positional parameter name change from `claude_binary` to `opencode_binary` does NOT break existing test calls since they pass it positionally. But the test assertions should verify opencode command format.

    3. Add test `test_spawn_uses_opencode_command` in TestSpawnTeammate:
       - Mock subprocess, verify the tmux command string contains "opencode run" and NOT "CLAUDECODE"

    4. Update import: add `build_opencode_run_command` and `SPAWN_TIMEOUT_SECONDS` to the import block, remove `build_spawn_command` import (or keep for backward compat -- see note below).

    Run tests -- they MUST fail (build_opencode_run_command doesn't exist yet).

    GREEN phase - Implement:

    1. In src/claude_teams/spawner.py:
       a. Add constant: SPAWN_TIMEOUT_SECONDS = 300
       b. Add function `build_opencode_run_command(member: TeammateMember, opencode_binary: str, timeout_seconds: int = SPAWN_TIMEOUT_SECONDS) -> str`
          - Constructs: f"cd {shlex.quote(member.cwd)} && timeout {timeout_seconds} {shlex.quote(opencode_binary)} run --agent {shlex.quote(member.name)} --model {shlex.quote(member.model)} --format json {shlex.quote(member.prompt)}"
          - Does NOT include any Claude Code flags or env vars
          - Does NOT check plan_mode_required (no OpenCode equivalent)
       c. Rename parameter in spawn_teammate(): `claude_binary` -> `opencode_binary`
       d. In spawn_teammate(), replace: `cmd = build_spawn_command(member, claude_binary, lead_session_id)` with `cmd = build_opencode_run_command(member, opencode_binary)`
       e. Keep `build_spawn_command` function for now (Phase 8 cleanup will remove it). Do NOT delete it yet -- other code or tests may reference it.

    2. In src/claude_teams/server.py:
       a. Update the spawn_teammate call in spawn_teammate_tool(): change `claude_binary=ls["opencode_binary"]` to `opencode_binary=ls["opencode_binary"]`

    3. Update import in server.py if needed (build_opencode_run_command not directly imported by server.py since server calls spawn_teammate, not build_opencode_run_command directly).

    Run tests -- they MUST pass.

    IMPORTANT anti-patterns to avoid:
    - Do NOT use Python subprocess timeout (tmux returns immediately; timeout must be inside the pane command)
    - Do NOT pipe the prompt via stdin (opencode run expects positional argument)
    - Do NOT omit --format json (without it, spinner animation pollutes tmux pane)
    - Do NOT pass --model without provider prefix (must be "moonshot-ai/kimi-k2.5", not just "kimi-k2.5")
    - Do NOT set is_active=True before tmux spawn succeeds
    - Do NOT delete build_spawn_command yet (Phase 8 cleanup concern)
  </implementation>
</feature>

<verification>
1. `python -m pytest tests/test_spawner.py -v` -- all tests pass including new OpenCode command tests
2. `python -m pytest tests/ -v` -- full test suite passes (no regressions)
3. Grep verification: `grep -n "build_opencode_run_command" src/claude_teams/spawner.py` returns the function definition AND the call in spawn_teammate
4. Grep verification: `grep -n "opencode_binary" src/claude_teams/spawner.py` shows renamed parameter in spawn_teammate signature
5. Grep verification: `grep -n "opencode_binary" src/claude_teams/server.py` shows updated keyword argument
6. Negative check: `grep "CLAUDECODE" src/claude_teams/spawner.py` -- the new function does NOT contain CLAUDECODE (old build_spawn_command still will, that's fine for Phase 8 cleanup)
</verification>

<success_criteria>
- build_opencode_run_command() exists and produces correct command string with opencode run, --agent, --model, --format json, timeout
- spawn_teammate() accepts opencode_binary parameter (renamed from claude_binary)
- spawn_teammate() calls build_opencode_run_command instead of build_spawn_command
- server.py passes opencode_binary= keyword argument
- All new tests pass (command format, quoting, timeout, no Claude flags)
- All existing tests pass (no regressions)
- Requirements satisfied: SPAWN-06 (command construction), RELY-01 (timeout wrapping)
- Requirements already satisfied (unchanged): SPAWN-07 (tmux pane), SPAWN-08 (pane ID), SPAWN-09 (inbox delivery)
</success_criteria>

<output>
After completion, create `.planning/phases/03-spawn-execution/03-01-SUMMARY.md`
</output>
