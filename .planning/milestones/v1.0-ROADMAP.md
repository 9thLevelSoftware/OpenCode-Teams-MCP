# Milestone v1.0: OpenCode Teams MCP

**Status:** SHIPPED 2026-02-08
**Phases:** 1-8
**Total Plans:** 15

## Overview

Replaced the Claude Code spawning layer with OpenCode CLI + Kimi K2.5 support across 8 phases. The journey started with low-level binary discovery and model configuration, built up through agent config generation and spawn execution, validated inter-agent communication, then layered on reliability, templates, desktop support, and finally removed all legacy Claude Code paths.

## Phases

### Phase 1: Binary Discovery & Model Configuration

**Goal:** The system can locate the OpenCode binary and translate any model specification into the correct Kimi K2.5 provider format
**Depends on:** Nothing (first phase)
**Plans:** 2 plans

Plans:
- [x] 01-01-PLAN.md -- OpenCode binary discovery, version validation, model translation, and provider config functions
- [x] 01-02-PLAN.md -- Wire discovery and model translation into MCP server layer

**Details:**
- discover_opencode_binary() finds opencode on PATH via shutil.which, validates version >= 1.1.52
- translate_model() maps Claude aliases (sonnet/opus/haiku) to provider-specific kimi-k2.5 strings
- 4 provider configs: moonshot-ai, moonshot-ai-china, openrouter, novita

### Phase 2: Agent Config Generation

**Goal:** The system generates complete, valid `.opencode/agents/<name>.md` config files that give a spawned agent its identity, team awareness, communication instructions, and MCP tool access
**Depends on:** Phase 1 (model/provider format needed in configs)
**Plans:** 2 plans

Plans:
- [x] 02-01-PLAN.md -- Config generation module with TDD: generate_agent_config, write_agent_config, ensure_opencode_json
- [x] 02-02-PLAN.md -- Wire config generation into spawn flow and add cleanup on kill/shutdown

**Details:**
- YAML frontmatter with mode="primary", permission="allow", tools dict
- claude-teams_* wildcard enables all MCP tools
- System prompt sections: identity, inbox polling, task management, shutdown protocol

### Phase 3: Spawn Execution

**Goal:** The system can launch an OpenCode agent in a tmux pane with a correct command, track its pane ID, and deliver an initial task prompt
**Depends on:** Phase 1 (binary path), Phase 2 (agent config must exist before spawn)
**Plans:** 1 plan

Plans:
- [x] 03-01-PLAN.md -- Replace build_spawn_command with build_opencode_run_command, add timeout wrapping, rename claude_binary to opencode_binary

**Details:**
- Constructs `opencode run --agent <name>` commands
- Timeout wrapping via shell 'timeout' command inside tmux pane

### Phase 4: MCP Communication Validation

**Goal:** Spawned agents can actually use the MCP server to read their inbox, send messages to teammates, and operate on shared task state
**Depends on:** Phase 2 (MCP config in agent), Phase 3 (agents are running)
**Plans:** 2 plans

Plans:
- [x] 04-01-PLAN.md -- Single-agent MCP tool access verification and config_gen send_message fix
- [x] 04-02-PLAN.md -- Multi-agent message exchange, task sharing, and filesystem state verification

**Details:**
- Validated bidirectional message exchange between alice and bob agents
- Proved MCP-03: two separate Client sessions share filesystem state

### Phase 5: Agent Health & Monitoring

**Goal:** The system can detect when a spawned agent has died or hung, and forcefully terminate unresponsive agents
**Depends on:** Phase 3 (agents must be spawnable to monitor them)
**Plans:** 2 plans

Plans:
- [x] 05-01-PLAN.md -- Core health detection functions: AgentHealthStatus model, check_pane_alive, capture_pane_content_hash, check_single_agent_health, health state persistence
- [x] 05-02-PLAN.md -- MCP tool exposure: check_agent_health and check_all_agents_health tools with integration tests

**Details:**
- Queries tmux pane to determine if OpenCode process is alive or exited
- Detects hung agents (process alive but no output for configurable duration)
- Force-kills unresponsive instances and cleans up tmux panes

### Phase 6: Agent Templates

**Goal:** Users can spawn agents with pre-built role templates (researcher, implementer, reviewer, tester) that include role-appropriate system prompts and can be customized per-spawn
**Depends on:** Phase 2 (config generation is the foundation templates build on)
**Plans:** 2 plans

Plans:
- [x] 06-01-PLAN.md -- Template data model (AgentTemplate dataclass), 4 built-in role definitions, and config_gen extension for role_instructions/custom_instructions injection
- [x] 06-02-PLAN.md -- Wire template lookup into spawn flow and MCP tools: template param on spawn_teammate, list_agent_templates tool

**Details:**
- 4 templates: researcher, implementer, reviewer, tester
- Template lookup in server.py, role_instructions passthrough to spawner
- custom_instructions enables per-spawn customization

### Phase 7: Desktop Spawning

**Goal:** The system can spawn OpenCode desktop app instances as an alternative to CLI tmux panes, on Windows, macOS, and Linux
**Depends on:** Phase 3 (shares spawn infrastructure, alternative execution path)
**Plans:** 2 plans

Plans:
- [x] 07-01-PLAN.md -- Desktop binary discovery, process launch/liveness/kill functions, TeammateMember process_id field
- [x] 07-02-PLAN.md -- Wire desktop backend into spawn flow, MCP tools, force_kill branching, health check branching

**Details:**
- discover_opencode_desktop() finds desktop app on all three platforms
- launch_desktop_app uses subprocess.Popen for real PID tracking
- Desktop health check returns alive/dead only (no hung detection)

### Phase 8: Legacy Cleanup

**Goal:** All Claude Code-specific code is removed, all tests pass against the new OpenCode spawning, and documentation reflects the current system
**Depends on:** Phases 1-5 (all new functionality must be in place before removing old code)
**Plans:** 2 plans

Plans:
- [x] 08-01-PLAN.md -- Remove discover_claude_binary, build_spawn_command, and dead lead_session_id parameter
- [x] 08-02-PLAN.md -- Update Claude model strings to Kimi K2.5 and rewrite README/documentation for OpenCode

**Details:**
- discover_claude_binary() removed
- All model strings changed to moonshot-ai/kimi-k2.5
- README rewritten for OpenCode + Kimi K2.5 setup

---

## Milestone Summary

**Key Decisions:**
- Replace Claude Code entirely, not hybrid -- cleaner implementation
- Dynamic agent config generation via `.opencode/agents/<name>.md`
- Permission string "allow" for OpenCode non-interactive mode
- Tuple version comparison to avoid packaging.version dependency
- Template lookup in MCP layer, spawner receives resolved role_instructions

**Issues Resolved:**
- Windows/fcntl compatibility via conditional import (msvcrt on Windows, fcntl on POSIX)
- MCP-03 filesystem state sharing confirmed via cross-context tests
- send_message type='message' always attributes from='team-lead' -- understood and documented

**Issues Deferred:**
- None (all tech debt accepted as documented)

**Technical Debt Incurred:**
- Tests require WSL/Linux due to fcntl file locking (POSIX-only)
- Human verification recommended for end-to-end health detection with real tmux panes

---

_For current project status, see .planning/PROJECT.md_
